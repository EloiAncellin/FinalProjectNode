<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Chat</title>
    <meta name="description" content="Chat">
    <meta name="author" content="Arthur Desutter">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <style>
        .container{max-width:1170px; margin:auto;}
        img{ max-width:100%;}
        .inbox_people {
            background: #f8f8f8 none repeat scroll 0 0;
            float: left;
            overflow: hidden;
            width: 40%; border-right:1px solid #c4c4c4;
        }
        .inbox_msg {
            border: 1px solid #c4c4c4;
            clear: both;
            overflow: hidden;
        }
        .top_spac{ margin: 20px 0 0;}


        .recent_heading {float: left; width:40%;}
        .srch_bar {
            display: inline-block;
            text-align: right;
            width: 60%;
        }
        .headind_srch{ padding:10px 29px 10px 20px; overflow:hidden; border-bottom:1px solid #c4c4c4;}

        .recent_heading h4 {
            color: #05728f;
            font-size: 21px;
            margin: auto;
        }
        .srch_bar input{ border:1px solid #cdcdcd; border-width:0 0 1px 0; width:80%; padding:2px 0 4px 6px; background:none;}
        .srch_bar .input-group-addon button {
            background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
            border: medium none;
            padding: 0;
            color: #707070;
            font-size: 18px;
        }
        .srch_bar .input-group-addon { margin: 0 0 0 -27px;}

        .chat_ib h5{ font-size:15px; color:#464646; margin:0 0 8px 0;}
        .chat_ib h5 span{ font-size:13px; float:right;}
        .chat_ib p{ font-size:14px; color:#989898; margin:auto}
        .chat_img {
            float: left;
            width: 11%;
        }
        .chat_ib {
            float: left;
            padding: 0 0 0 15px;
            width: 88%;
        }

        .chat_people{ overflow:hidden; clear:both;}
        .chat_list {
            border-bottom: 1px solid #c4c4c4;
            margin: 0;
            padding: 18px 16px 10px;
        }
        .inbox_chat { height: 550px; overflow-y: scroll;}

        .active_chat{ background:#ebebeb;}

        .incoming_msg_img {
            display: inline-block;
            width: 6%;
        }
        .received_msg {
            display: inline-block;
            padding: 0 0 0 10px;
            vertical-align: top;
            width: 92%;
        }
        .received_withd_msg p {
            background: #ebebeb none repeat scroll 0 0;
            border-radius: 3px;
            color: #646464;
            font-size: 14px;
            margin: 0;
            padding: 5px 10px 5px 12px;
            width: 100%;
        }
        .time_date {
            color: #747474;
            display: block;
            font-size: 12px;
            margin: 8px 0 0;
        }
        .received_withd_msg { width: 57%;}
        .mesgs {
            float: left;
            padding: 30px 15px 0 25px;
            width: 60%;
        }

        .sent_msg p {
            background: #05728f none repeat scroll 0 0;
            border-radius: 3px;
            font-size: 14px;
            margin: 0; color:#fff;
            padding: 5px 10px 5px 12px;
            width:100%;
        }
        .outgoing_msg{ overflow:hidden; margin:26px 0 26px;}
        .sent_msg {
            float: right;
            width: 46%;
        }
        .input_msg_write input {
            background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
            border: medium none;
            color: #4c4c4c;
            font-size: 15px;
            min-height: 48px;
            width: 100%;
        }

        .type_msg {border-top: 1px solid #c4c4c4;position: relative;}
        .msg_send_btn {
            background: #05728f none repeat scroll 0 0;
            border: medium none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            font-size: 17px;
            height: 33px;
            position: absolute;
            right: 0;
            top: 11px;
            width: 33px;
        }
        .messaging { padding: 0 0 50px 0;}
        .msg_history {
            height: 516px;
         5   overflow-y: auto;
        }
    </style>
</head>

<body>

<div class="container mt-5">
    <h3 class=" text-center">TodoList</h3>
    <div class="card">
        <div class="card-header">
            <h1>Ma TodoList :</h1>
        </div>
        <ul id="todolist_container" class="list-group list-group-flush">
            <!-- ici sont rajoutes les tâches de la todolist -->
        </ul>

        <!--<h3>Aucune tâche en cours</h3> -->
        <div class="card-body">
            <form action="#" class="form-inline" id="form_task">
                <div class="form-group">
                    <label class="mr-2" for="newtodo">Que devons nous faire ?</label>
                    <textarea type="text" name="newtodo" id="newtodo" autofocus></textarea>
                </div>
                <button type="submit" class="m-2 btn btn-primary">Ajouter</button>
            </form>
        </div>
    </div>
</div>
<br/>
<div class="container">
    <h3 class=" text-center">Chat</h3>
    <div class="messaging">
        <div class="inbox_msg">
            <div class="inbox_people">
                <div class="headind_srch">
                    <div class="recent_heading">
                        <h4>En ligne</h4>
                    </div>
                    <div class="srch_bar">
                        <div class="stylish-input-group">
                            <input id="search_user" type="text" class="search-bar"  placeholder="Search" >
                            <span class="input-group-addon">
                <button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>
                </span> </div>
                    </div>
                </div>
                <div class="inbox_chat" id="user_list">
                        <!-- Les utilisateurs sont ajoutés ici -->

                </div>
            </div>
            <div class="mesgs">
                <div class="msg_history" id="msg-history">
                    <!-- Les messages sont ajoutés ici-->

                </div>
                <div class="type_msg">
                    <div class="input_msg_write">
                        <form id="form_message">
                        <input id="message_to_send" type="text" class="write_msg" placeholder="Taper votre message ..." />
                        <button class="msg_send_btn" type="submit"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>



<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.dev.js"></script>

<script>

        function toggle_form(id) {
            var element = document.getElementById("form-change-" + id);
            if (element.style.display == 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }

        $("#search_user").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#user_list div").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });

        function information_message(type, user, date){
            $('#msg-history').append(
                "<p class=\"time_date text-center\">"+user+" s'est "+type+" le "+date+"</p>");
        }

        function add_inc_message(user, message, date) {
            $('#msg-history').append(
                "<div class=\"incoming_msg\">" +
                "<div class=\"incoming_msg_img\"> <img src=\"https://ptetutorials.com/images/user-profile.png\" alt=\"sunil\"> </div>"+
                "<div class=\"received_msg\">"+
                "<div class=\"received_withd_msg\">"+
                "<p>"+message+"</p>"+
                "<span class=\"time_date\">"+date+" | "+user+"</span></div>"+
                "</div>"+
                "</div>"
            );
        }

        function add_out_message(message, date) {
            $('#msg-history').append(
                "<div class=\"outgoing_msg\">"+
                "<div class=\"sent_msg\">"+
                "<p>"+message+"</p>"+
                "<span class=\"time_date\">"+date+"</span></div>"+
                "</div>");
        }

        function add_user(user, date){
            if(user === pseudo){
                $('#user_list').prepend(
                    "<div id=\""+user+"\" class=\"chat_list active_chat\">" +
                    "<div  class=\"chat_people\">" +
                    "<div id=\"img-div-"+user+"\" class=\"chat_img\"> <img id=\"img-"+user+"\" src=\"https://ptetutorials.com/images/user-profile.png\" alt=\"sunil\"> </div>" +
                    "<div class=\"chat_ib\">" +
                    "<h5>"+user+"<span class=\"chat_date\">"+date+"</span></h5>" +
                    "<p></br></p>" +
                    "</div>" +
                    "</div>" +
                    "</div>"
                );
            }else{
                $('#user_list').append(
                    "<div id=\""+user+"\" class=\"chat_list\">" +
                    "<div  class=\"chat_people\">" +
                    "<div class=\"chat_img\"> <img src=\"https://ptetutorials.com/images/user-profile.png\" alt=\"sunil\"> </div>" +
                    "<div class=\"chat_ib\">" +
                    "<h5>"+user+"<span class=\"chat_date\">"+date+"</span></h5>" +
                    "<p></br></p>" +
                    "</div>" +
                    "</div>" +
                    "</div>"
                );
            }


        }

        function add_task(task){
            $('#todolist_container').append(
        "<li class=\"list-group-item\">"+
                "<a class=\"text-dark\" onclick=\"delete_task("+task[0]+")\">✘</a>"+
            "<a class=\"text-dark\" onclick=\"toggle_form("+task[0]+")\">𝌡</a>"+
            "<a class=\"text-dark\" onclick=\"go_up("+task[0]+")\">↑</a>"+
            "<a class=\"text-dark\" onclick=\"go_down("+task[0]+")\">↓</a>"+
            "-"+task[1]+"<p class=\"text-right font-weight-light font-italic\">"+task[2]+" - "+task[3]+"</p>"+
             "   <form style=\"display: none\" class='form-change' onsubmit='manage_task(event, "+task[0]+")' id=\"form-change-"+task[0]+"\">"+
              " <div class=\"form-group\">"+
            "<input type='hidden' value='"+task[0]+"'>"+
               " <label for=\"changeTodo\">Texte à modifier :</label>"+
            "<textarea type=\"text-area\" name=\"changeTodo\" id=\"changeTodo-"+task[0]+"\" style=\"min-width: 100%\">"+task[1]+"</textarea>"+

                "</div>"+
                "<button type=\"submit\" class=\"btn btn-primary\">Modifier</button>"+
                "</form>"+
                "</li>");
        }


        function go_up(id) {
            todolistIO.emit('go up', id);
        }
        function go_down(id) {
            todolistIO.emit('go down', id);
        }

        function manage_task(e, id){
            e.preventDefault();
            var id_text = '#changeTodo-'+id;
            todolistIO.emit('manage task', [id, $(id_text).val()]);
            return false;
        }

        function delete_task(id) {
            todolistIO.emit('remove task', id);
        }

        // Connexion à socket.io
        var chat = io.connect('http://localhost:8080/my-chat');
        var todolistIO = io.connect('http://localhost:8080/my-todoList');


        //on mets à jour les utilisateurs
        chat.on('user joined', function (data) {
            information_message("connecté", data[0][0], data[0][1]);
            $('#user_list').empty();
            data[1].forEach(function (element) {
                add_user(element[0], element[1]);
            })
        })

        chat.on('user disconnected', function(data) {
            information_message("déconnecté", data[0][0], data[0][1]);
            $('#user_list').empty();
            data[1].forEach(function (element) {
                add_user(element[0], element[1]);
            })
        })

        //recpection d'un message
        chat.on('nouveau_message', function (data) {
            if(data[0] === pseudo){
                add_out_message(data[1], data[2]);
            }else{
                add_inc_message(data[0], data[1], data[2]);
            }
        })

        $('#form_message').submit(function (event) {
            event.preventDefault();
            var input_box = $('#message_to_send')
            chat.emit('send message', input_box.val());
            input_box.val("");
        });

        $('#form_task').submit(function (event) {
            event.preventDefault();
            var newtodo_box = $('#newtodo');
            todolistIO.emit('add task', newtodo_box.val());
            newtodo_box.val("");
        })



        todolistIO.on('update todolist', function (data) {
            $('#todolist_container').empty();
            data.forEach(function (element) {
                add_task(element);
            })

        });


        // On demande le pseudo, on l'envoie au serveur et on l'affiche dans le titre
        var pseudo = "";
        while(pseudo === null || pseudo ===""){
            pseudo = prompt('Quel est votre pseudo ?');
        }
        chat.emit('add user', pseudo);
        todolistIO.emit('add user', pseudo);
        document.title = pseudo + ' - ' + document.title;

</script>

</html>

